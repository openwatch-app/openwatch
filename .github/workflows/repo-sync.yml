name: Sync Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with Target Repo
        env:
          TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}
          TARGET_REPO_URL: ${{ secrets.TARGET_REPO_URL }}
          USER_EMAIL: 'actions@openwatch.app'
          USER_NAME: 'OpenWatch Sync Bot'
        run: |
          if [ -z "$TARGET_REPO_PAT" ]; then
            echo "::error::TARGET_REPO_PAT secret is not set. Please add it to your repository secrets."
            exit 1
          fi

          if [ -z "$TARGET_REPO_URL" ]; then
            echo "::error::TARGET_REPO_URL secret is not set. Please add it to your repository secrets."
            exit 1
          fi

          # Configure git global user
          git config --global user.email "$USER_EMAIL"
          git config --global user.name "$USER_NAME"

          echo "Cloning target repository..."
          # Clone the target repo using the PAT for authentication
          # We strip the protocol (https://) from the URL secret and inject credentials
          CLEAN_URL="${TARGET_REPO_URL#https://}"
          git clone https://$USER_NAME:$TARGET_REPO_PAT@$CLEAN_URL target-repo

          cd target-repo

          echo "Adding source repository as remote..."
          # Add the current (source) repo as a remote
          git remote add source https://github.com/${{ github.repository }}.git

          # Check if the repo is empty (unborn branch)
          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "Target repository is empty. Pulling initial content..."
            git pull source main
          else
            echo "Merging changes from source/main..."
            git fetch source
            # Merge source main into the current branch (assumed main)
            if git merge source/main --allow-unrelated-histories --no-edit; then
              echo "Merge successful."
            else
              echo "::error::Merge conflict detected. Manual intervention required."
              git status
              exit 1
            fi
          fi

          echo "Pushing changes to target repository..."
          git push origin main
