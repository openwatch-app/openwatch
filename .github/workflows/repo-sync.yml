name: Sync Repository

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync with Target Repo
        env:
          TARGET_REPO_PAT: ${{ secrets.TARGET_REPO_PAT }}
          TARGET_REPO_URL: ${{ secrets.TARGET_REPO_URL }}
          USER_EMAIL: 'actions@openwatch.app'
          USER_NAME: 'OpenWatchSyncBot'
        run: |
          if [ -z "$TARGET_REPO_PAT" ]; then
            echo "::error::TARGET_REPO_PAT secret is not set."
            exit 1
          fi

          if [ -z "$TARGET_REPO_URL" ]; then
            echo "::error::TARGET_REPO_URL secret is not set."
            exit 1
          fi

          # Configure git global user
          git config --global user.email "$USER_EMAIL"
          git config --global user.name "$USER_NAME"

          echo "Cloning target repository..."
          # Clone the target repo using the PAT for authentication
          CLEAN_URL="${TARGET_REPO_URL#https://}"
          git clone https://$USER_NAME:$TARGET_REPO_PAT@$CLEAN_URL target-repo

          cd target-repo

          echo "Adding source repository as remote..."
          # Add the current (source) repo as a remote
          git remote add source https://github.com/${{ github.repository }}.git

          # Check if the repo is empty (unborn branch)
          if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            echo "Target repository is empty. Pulling initial content..."
            git pull source main
          else
            echo "Merging changes from source/main..."
            git fetch source
            
            # Merge source main into the current branch (assumed main)
            git merge source/main --allow-unrelated-histories --no-commit || true

            # List of files/paths to exclude from sync
            IGNORED_PATHS=".github package.json package-lock.json README.md compose.yml CONTRIBUTING.md LICENSE"

            echo "Restoring protected files from target (HEAD)..."
            for path in $IGNORED_PATHS; do
              # Restore from HEAD if exists, otherwise remove (skip addition)
              git reset HEAD -- "$path" 2>/dev/null || true
              
              if git checkout HEAD -- "$path" 2>/dev/null; then
                echo "Restored $path from HEAD."
              else
                echo "$path not found in HEAD. Removing from merge..."
                git rm -rf "$path" 2>/dev/null || true
              fi
            done

            # Check for remaining conflicts in non-ignored files
            if git ls-files -u | grep -q .; then
              echo "::error::Merge conflict detected in non-ignored files. Manual intervention required."
              git status
              exit 1
            fi

            # Commit the merge
            git commit -m "Sync from source (skipping protected files)" || echo "No changes to commit."
            echo "Merge successful."
          fi

          echo "Pushing changes to target repository..."
          git push origin main
